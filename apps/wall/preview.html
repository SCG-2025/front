<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PC 아바타 월드 - 크기 미리보기</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.3/p5.min.js"></script>
  <style>
    body {
      margin: 0;
      background: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    canvas {
      display: block;
      border: 2px solid #fff;
    }
  </style>
</head>

<body>
  <script>
    let avatarImage;
    let testAvatars = [];
    let selectedAvatar = null;
    let selectedStageAvatar = null; // 무대 아바타 선택용
    let isDragging = false;
    let showPopup = false;
    let popupAvatar = null;
    let dragOffset = { x: 0, y: 0 };

    function preload() {
      avatarImage = loadImage('avatar_sample.jpeg');
    }

    function setup() {
      createCanvas(2560, 1760); // 아이맥 가로 화면에 맞춰 확장 (1920 → 2560)
      
      // 테스트용 움직이는 아바타들 생성 (5개)
      for (let i = 0; i < 5; i++) {
        testAvatars.push({
          x: random(200, 2360), // 새로운 가로 크기에 맞춤
          y: random(900, 1500),
          vx: random(-1, 1),
          vy: random(-1, 1),
          direction: random() > 0.5 ? 1 : -1,
          walkTimer: random(60, 240),
          idleTimer: 0,
          currentAction: 'walking',
          // 임시 데이터 추가
          nickname: '삐삐',
          memory: '초등학생 때 부모님과 함께 함덕해수욕장에 간 기억이 있어요',
          keywords: '부모님, 초등학생, 해수욕장'
        });
      }
      
      drawMainScreen();
    }

    function draw() {
      drawMainScreen();
      
      // 테스트 아바타들 애니메이션
      testAvatars.forEach(avatar => {
        // 멈춘 상태면 움직이지 않음
        if (avatar.currentAction === 'stopped') {
          // 아무것도 하지 않음
        }
        else if (avatar.currentAction === 'idle') {
          avatar.idleTimer--;
          if (avatar.idleTimer <= 0) {
            const directions = [
              {dx: 1, dy: 0}, {dx: -1, dy: 0}, {dx: 0, dy: 1}, {dx: 0, dy: -1}
            ];
            const dir = random(directions);
            avatar.vx = dir.dx * random(0.5, 1.5);
            avatar.vy = dir.dy * random(0.5, 1.5);
            avatar.direction = avatar.vx > 0 ? 1 : (avatar.vx < 0 ? -1 : avatar.direction);
            avatar.currentAction = 'walking';
            avatar.walkTimer = random(60, 240);
          }
        } else if (avatar.currentAction === 'walking') {
          avatar.walkTimer--;
          avatar.x += avatar.vx;
          avatar.y += avatar.vy;
          
          if (avatar.walkTimer <= 0) {
            avatar.vx = 0;
            avatar.vy = 0;
            avatar.currentAction = 'idle';
            avatar.idleTimer = random(30, 120);
          }
          
          // 경계 충돌 처리 (걷는 중일 때만)
          if (avatar.x < 0 || avatar.x > 2560) {
            avatar.vx *= -1;
            avatar.direction *= -1;
            avatar.x = constrain(avatar.x, 0, 2560);
          }
          if (avatar.y < 480 || avatar.y > 1760) {
            avatar.vy *= -1;
            avatar.y = constrain(avatar.y, 480, 1760);
          }
          
          // 무대 충돌 처리
          const stageLeft = 853, stageRight = 1707, stageTop = 480, stageBottom = 800;
          if (avatar.y >= stageTop && avatar.y <= stageBottom && 
              avatar.x >= stageLeft && avatar.x <= stageRight) {
            const centerX = (stageLeft + stageRight) / 2;
            const centerY = (stageTop + stageBottom) / 2;
            const dx = avatar.x - centerX;
            const dy = avatar.y - centerY;
            
            if (Math.abs(dx) > Math.abs(dy)) {
              avatar.vx *= -1;
              avatar.direction *= -1;
              avatar.x = dx > 0 ? stageRight + 5 : stageLeft - 5;
            } else {
              avatar.vy *= -1;
              avatar.y = dy > 0 ? stageBottom + 5 : stageTop - 5;
            }
          }
        }

        // 아바타 그리기
        push();
        translate(avatar.x, avatar.y);
        if (avatar.direction === -1) {
          scale(-1, 1);
        }
        imageMode(CENTER);
        
        // 선택된 아바타는 더 크게 표시하고 하이라이트 효과 추가
        if (selectedAvatar && selectedAvatar.nickname === avatar.nickname) {
          // 배경 원 (하이라이트 효과)
          fill(255, 215, 0, 150); // 골드 색상, 반투명
          ellipse(0, 0, 90, 90);
          // 선택된 아바타는 1.25배 크기
          image(avatarImage, 0, 0, 80, 80);
        } else {
          // 일반 아바타
          image(avatarImage, 0, 0, 64, 64);
        }
        pop();
      });
      
      // 팝업창 그리기
      if (showPopup && popupAvatar) {
        drawPopup();
      }
    }

    function drawMainScreen() {
      background('#222');
      
      // 스크린 공간 (회색, 2560x480)
      fill('#cccccc');
      rect(0, 0, 2560, 480);

      // 무대 공간 (갈색, 가운데 1/3 = 853px)
      const stageW = 2560 / 3; // 853.33
      const stageX = (2560 - stageW) / 2;
      fill('#a67c52');
      rect(stageX, 480, stageW, 320);

      // 자유 공간 (하늘색)
      fill('#7ecbff');
      noStroke();
      rect(0, 800, 2560, 960); // 무대 아래 전체
      rect(0, 480, stageX, 320); // 왼쪽
      rect(stageX + stageW, 480, stageX, 320); // 오른쪽

      // 스크린 3분할 표시선
      stroke('#888');
      strokeWeight(2);
      for (let i = 1; i < 3; i++) {
        line((2560 / 3) * i, 0, (2560 / 3) * i, 480);
      }
      noStroke();

      // 무대 아바타들 (6명)
      const spacing = stageW / 7;
      for (let i = 0; i < 6; i++) {
        const x = stageX + spacing * (i + 1);
        push();
        translate(x, 640);
        imageMode(CENTER);
        
        // 선택된 무대 아바타는 더 크게 표시하고 하이라이트 효과 추가
        if (selectedStageAvatar === i) {
          // 배경 원 (하이라이트 효과)
          fill(255, 215, 0, 150); // 골드 색상, 반투명
          ellipse(0, 0, 90, 90);
          // 선택된 아바타는 1.25배 크기
          image(avatarImage, 0, 0, 80, 80);
        } else {
          // 일반 아바타
          image(avatarImage, 0, 0, 64, 64);
        }
        pop();
      }

      // 화면 정보 표시
      fill(255);
      textSize(16);
      textAlign(LEFT);
      text('Canvas Size: 2560 x 1760 (iMac 적합)', 20, 30);
      text('Avatar Size: 64 x 64 pixels', 20, 50);
      text('Stage Avatars: 6 (fixed)', 20, 70);
      text('Moving Avatars: ' + testAvatars.length + ' (animated)', 20, 90);
    }

    // 마우스 이벤트 처리
    function mousePressed() {
      // 팝업이 열려있을 때
      if (showPopup) {
        // 닫기 버튼 클릭 (팝업 우상단)
        if (mouseX >= 2260 && mouseX <= 2290 && mouseY >= 1310 && mouseY <= 1340) {
          closePopup();
          return;
        }
        // 팝업 영역 외부 클릭
        if (mouseX < 200 || mouseX > 2360 || mouseY < 1300 || mouseY > 1650) {
          closePopup();
          return;
        }
        // 팝업 내부 클릭은 무시
        return;
      }

      // 아바타 클릭 감지
      for (let avatar of testAvatars) {
        let distance = dist(mouseX, mouseY, avatar.x, avatar.y);
        if (distance <= 32) { // 64x64 아바타의 절반
          selectedAvatar = avatar;
          selectedStageAvatar = null; // 무대 아바타 선택 해제
          isDragging = false;
          dragOffset.x = mouseX - avatar.x;
          dragOffset.y = mouseY - avatar.y;
          
          // 아바타 멈추기
          avatar.currentAction = 'stopped';
          avatar.vx = 0;
          avatar.vy = 0;
          return;
        }
      }

      // 무대 아바타 클릭 감지 (고정 아바타)
      const stageW = 2560 / 3;
      const stageX = (2560 - stageW) / 2;
      const stageY = 640;
      const spacing = stageW / 7;
      
      for (let i = 0; i < 6; i++) {
        const x = stageX + spacing * (i + 1);
        let distance = dist(mouseX, mouseY, x, stageY);
        if (distance <= 32) { // 64x64 아바타의 절반
          selectedStageAvatar = i;
          selectedAvatar = null; // 동적 아바타 선택 해제
          return;
        }
      }
      
      // 기존 아바타 추가 기능 (자유공간 클릭 시)
      if (mouseX > 0 && mouseX < 2560 && mouseY > 800 && mouseY < 1760) {
        testAvatars.push({
          x: mouseX,
          y: mouseY,
          vx: random(-1, 1),
          vy: random(-1, 1),
          direction: random() > 0.5 ? 1 : -1,
          walkTimer: random(60, 240),
          idleTimer: 0,
          currentAction: 'walking',
          nickname: '삐삐',
          memory: '초등학생 때 부모님과 함께 함덕해수욕장에 간 기억이 있어요',
          keywords: '부모님, 초등학생, 해수욕장'
        });
      }
    }

    function mouseDragged() {
      if (selectedAvatar) {
        isDragging = true;
        selectedAvatar.x = mouseX - dragOffset.x;
        selectedAvatar.y = mouseY - dragOffset.y;
        
        // 경계 제한
        selectedAvatar.x = constrain(selectedAvatar.x, 0, 2560);
        selectedAvatar.y = constrain(selectedAvatar.y, 480, 1760);
        
        // 무대 영역 제한
        const stageLeft = 853, stageRight = 1707, stageTop = 480, stageBottom = 800;
        if (selectedAvatar.y >= stageTop && selectedAvatar.y <= stageBottom && 
            selectedAvatar.x >= stageLeft && selectedAvatar.x <= stageRight) {
          // 무대 밖으로 밀어내기
          const centerX = (stageLeft + stageRight) / 2;
          if (selectedAvatar.x < centerX) {
            selectedAvatar.x = stageLeft - 32;
          } else {
            selectedAvatar.x = stageRight + 32;
          }
        }
      }
    }

    function mouseReleased() {
      if (selectedAvatar) {
        if (!isDragging) {
          // 드래그하지 않고 클릭만 했으면 팝업 표시
          showPopupFor(selectedAvatar);
        } else {
          // 드래그 완료 - 아바타 다시 움직이게 함
          selectedAvatar.currentAction = 'idle';
          selectedAvatar.idleTimer = random(30, 120);
        }
        selectedAvatar = null;
        isDragging = false;
      }
      
      // 무대 아바타 선택 해제 (클릭만 했을 때)
      if (selectedStageAvatar !== null) {
        selectedStageAvatar = null;
      }
    }

    function showPopupFor(avatar) {
      popupAvatar = avatar;
      showPopup = true;
      // 아바타 멈춤 상태 유지
      avatar.currentAction = 'stopped';
    }

    function closePopup() {
      showPopup = false;
      if (popupAvatar) {
        // 아바타 다시 움직이게 함
        popupAvatar.currentAction = 'idle';
        popupAvatar.idleTimer = random(30, 120);
        popupAvatar = null;
      }
    }

    // 팝업창 그리기
    function drawPopup() {
      if (!popupAvatar) return;
      
      // 반투명 배경
      fill(0, 0, 0, 150);
      rect(0, 0, 2560, 1760);
      
      // 팝업창 배경 (화면 하단)
      fill(255, 255, 255);
      stroke(200);
      strokeWeight(2);
      rect(200, 1300, 2160, 350, 15); // 모서리 둥글게
      
      // 닫기 버튼 (X)
      fill(220, 220, 220);
      stroke(180);
      strokeWeight(1);
      rect(2260, 1310, 30, 30, 5);
      fill(100);
      noStroke();
      textAlign(CENTER, CENTER);
      textSize(20);
      text('×', 2275, 1325);
      
      // 아바타 이미지 (팝업 내부)
      push();
      translate(280, 1380);
      imageMode(CENTER);
      image(avatarImage, 0, 0, 80, 80); // 팝업에서는 더 크게
      pop();
      
      // 텍스트 정보
      fill(50);
      textAlign(LEFT, TOP);
      textSize(24);
      text('아바타 정보', 380, 1320);
      
      textSize(18);
      text('닉네임: ' + popupAvatar.nickname, 380, 1360);
      text('추억: ' + popupAvatar.memory, 380, 1390);
      text('키워드: ' + popupAvatar.keywords, 380, 1420);
      
      // 추가 설명
      fill(120);
      textSize(14);
      text('이 아바타를 드래그해서 원하는 위치로 이동시킬 수 있습니다.', 380, 1460);
      text('팝업 외부를 클릭하거나 X 버튼을 눌러 닫을 수 있습니다.', 380, 1480);
      
      noStroke();
    }
  </script>
</body>

</html>
